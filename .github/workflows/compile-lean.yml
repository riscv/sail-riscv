name: Build and test Lean backend

on: [push, pull_request, workflow_dispatch]

env:
  OPAMVERBOSE: 1

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          # Git history is needed for `git describe` in the build to work.
          fetch-depth: 0

      - name: System dependencies (ubuntu)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt install cvc4

      - name: Common setup
        uses: ./.github/actions/sail-setup
        with:
          sail-version: "latest"

      - name: Install Lean
        run: |
          wget -q https://raw.githubusercontent.com/leanprover-community/mathlib4/master/scripts/install_debian.sh
          bash install_debian.sh ; rm -f install_debian.sh

      - name: Build the Sail RISCV Model for Lean
        run: |
          eval $(opam config env)
          cmake -S . -B build -DCMAKE_BUILD_TYPE=RelWithDebInfo -G Ninja
          cmake --build build/ --target generated_lean_rv64d generated_lean_executable_rv64d

      - name: Restore cached .lake directory
        id: cache-lake-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            build/model/Lean_RV64D/.lake
            build/model/Lean_RV64D_executable/.lake
          key: ${{ matrix.os }}-lake

      - name: Use Lean to build the model and report errors
        run: |
          source ~/.profile
          cd build/model/Lean_RV64D/
          lake build

      - name: Save cached .lake directory
        id: cache-lake-save
        uses: actions/cache/save@v4
        with:
          path: |
            build/model/Lean_RV64D/.lake
            build/model/Lean_RV64D_executable/.lake
          key: ${{ steps.cache-lake-restore.outputs.cache-primary-key }}
